<html>
<head>
	<link rel="stylesheet" type="text/css" href="recipe.css" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script src="https://raw.github.com/BorisMoore/jsrender/master/jsrender.js" type="text/javascript"></script>
	<script src="js/recipe.js"></script>
	<!-- <script src="js/batch.js"></script> -->
	<script src="js/tumblr.js"></script>
	<script type="text/javascript">
	function getURLParameter(name) {
	    return decodeURI(
	        (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
	    );
	}
	function updateActualResults(evt){
		// Get values from form
		return {
			"mash":{
				"type": "",
				"duration":$('#mash_duration').val().trim(),
				"strike": {
					"volume":gallons2liters($('#mash_strike_volume').val().trim()),
					"temp":fahrenheitToCelsius($('#mash_strike_temp').val().trim())
				},
				"measurements": [
					{"temp": 0}
				]
			},
			"sparge": {
				"duration": $('#lauter_time').val().trim()
			},
			"boil": {
				"volume":	 gallons2liters($('#boil_volume').val().trim()),
				"sg":		 $('#boil_sg').val().trim(),
				"time":		 $('#boil_time').val().trim(),
				"end_volume":gallons2liters($('#boil_end_volume').val().trim())
			},
			"gravity": {
				"volume": gallons2liters($('#final_volume').val().trim().length ? $('#final_volume').val().trim() : $('#boil_end_volume').val().trim()),
				"og": $('#actual_og').val().trim(),
				"fg": $('#actual_fg').val().trim()
			}
		};
	}
										
	function updateActualResultsUI(evt,expected) {
		var results=updateActualResults();

		// Update evaporation rate
		$('#evaporation_rate').html($('#evaporationRateTemplate').render(results.boil));

		// Update boil end gravity
		if (results.boil.sg && results.boil.volume && results.boil.end_volume)
			$('#boil_end_gravity').html(((results.boil.sg - 1) * 1000 * liters2gallons(results.boil.volume) / liters2gallons(results.boil.end_volume) / 1000 + 1).toFixed(3));

		// Update final volume			
		$('#final_volume').val(liters2gallons(results.gravity.volume));

		// Update mash efficiency
		if (results && results.boil && results.boil.sg && results.boil.volume && expected.total_gu)
			$('#mash_efficiency').html(((((results.boil.sg - 1) * 1000) * liters2gallons(results.boil.volume)) / expected.total_gu * 100).toFixed(0) + "%");
		else
			$('#mash_efficiency').html("");

		// Update brewhouse efficiency
		if (results.gravity.volume && results.gravity.og)
			$('#brewhouse_efficiency').html((liters2gallons(results.gravity.volume) * sg2gu(results.gravity.og) / expected.total_gu * 100).toFixed(0) + "%");
		else
			$('#brewhouse_efficiency').html("");
			
		// Update ABV
		if (results.gravity.og && results.gravity.fg)
			$('#actual_abv').html(((sg2gu(results.gravity.og) - sg2gu(results.gravity.fg)) * 131 / 1000).toFixed(2) + "%");
		else
			$('#actual_abv').html("");
		
		// Update ADF
		if (results.gravity.og && results.gravity.fg)
			$('#actual_adf').html(((1 - (sg2gu(results.gravity.fg) / sg2gu(results.gravity.og))) * 100).toFixed(0) + "%");
		else
			$('#actual_adf').html("");
	}
	
	function renderBatch(batchId) {
		
		$.views.helpers({
			liters2gallons: liters2gallons,
			gallons2liters: gallons2liters,
			celsius2fahrenheit: celsiusToFahrenheit,
			fahrenheit2celsius: fahrenheitToCelsius
		})
		
		$('#topnav').append(" &gt; Batch " + batchId);
		
		// Create a place to put the templates we're going to include
		$(document.body).append('<div id="batchTemplates"></div>');

		// Create a place to put the templates we're going to include
		$(document.body).append('<div id="recipeTemplates"></div>');
				
		$('#batchTemplates').load("templates/batch.html",
			null,
			function(data,textStatus,xhr) {
				$('#recipeTemplates').load("templates/recipe.html",
					null,
					function(data,textStatus,xhr) {
						// Get the recipe Id from the batch
						$.getJSON("batches/" + batchId + "/batch.json",
							null,
							function(batchData,textStatus,xhr) {
								console.log("got batch.json:");
								console.log(batchData);
								displayRecipe(batchData.recipe.url,$('#recipe'),$('#recipeTemplate'),function(recipe) {
									//
									// Compute the expected data
									//
									
									// For recipes with adjuncts, the PPG may be lower than the total_ppg. We just want
									// to calculate the GU for the grains because that's what is mashed. Adjuncts
									// are added to the boil kettle and shouldn't be included in the lautered gravity.
									recipe.total_grain_ppg=0;
									recipe.total_adjunct_ppg=0;
									for (var i=0; i< recipe.ingredients.fermentables.list.length; ++i) {
										if (recipe.ingredients.fermentables.list[i].type=="Grain")
											recipe.total_grain_ppg+=recipe.ingredients.fermentables.list[i].yield / 100 * 46 * kg2lbs(recipe.ingredients.fermentables.list[i].amount);
										else
											recipe.total_adjunct_ppg+=recipe.ingredients.fermentables.list[i].yield / 100 * 46 * kg2lbs(recipe.ingredients.fermentables.list[i].amount);
									}
									
									var expected={
										// Assumptions:
										assumptions: {
											graintemp:fahrenheitToCelsius(70),
											mashtemp:fahrenheitToCelsius(152),
											mashthickness:1.5,
											mashtun_loss:0.946353,
											evaporation_rate:.17
										},
										total_gu: recipe.total_ppg,
										expected_gu: recipe.total_ppg * recipe.efficiency / 100,
										/*
											Mash volume:
											1.5 quarts (1.41953 liters) per 1 lb (0.453592kg) of grain 
										*/
										mashvol: recipe.ingredients.fermentables.total_weight / 0.453592 * 1.41953,
										/*
											Absorption loss:
											1.2 gallons of water per 10lbs grain
										    4.54249L of water per 4.53592kg grain
										*/
										absorption_loss_vol: 4.54249 * (recipe.ingredients.fermentables.total_weight / 4.53592),
										/* Hop absorption loss calc: http://www.homebrewtalk.com/f12/leaf-hop-absorption-measured-241469/ 
											138.3ml (0.1383L) per oz of hops
										*/
										hop_absorption_loss_vol: (recipe.ingredients.hops.total_weight * 28.3495) * 0.1383,
										boil_hours: recipe.boil_time / 60
									}
							
									expected.boil_vol= recipe.batch_size / (Math.pow(1 - expected.assumptions.evaporation_rate,expected.boil_hours));
									expected.evaporation_loss_vol=expected.boil_vol * (1 - Math.pow(1 - expected.assumptions.evaporation_rate,expected.boil_hours)),
									expected.sparge_vol=expected.boil_vol - (expected.mashvol - expected.absorption_loss_vol - expected.hop_absorption_loss_vol - expected.assumptions.mashtun_loss);
									//expected.sparge_vol=expected.boil_vol - (expected.mashvol - expected.absorption_loss_vol - expected.hop_absorption_loss_vol - expected.assumptions.mashtun_loss);
									expected.lauter_gravity=gu2sg((recipe.total_grain_ppg * recipe.efficiency / 100) / liters2gallons(expected.boil_vol)); 
									expected.adjunct_gu=recipe.total_adjunct_ppg / liters2gallons(expected.boil_vol);

									$('#expected').html($('#expectedTemplate').render(expected));

									//
									// Display the actual results data
									//
									$('#actual').html($('#actualTemplate').render({
										recipe: recipe,
										expected: expected,
										results: batchData.results
									}));
									updateActualResultsUI(null,expected);
									
									// Setup javsacript triggers
									$('#lauter_time').change(function(evt) {
										if ($.isNumeric($('#boil_volume').val()))
											$('#lauter_rate').html(($('#lauter_time').val() / $('#boil_volume').val()).toFixed(0));
										else
											$('#lauter_rate').html("");
									});
									
									$('#boil_volume').change(function(evt){updateActualResultsUI(evt,expected);});
									$('#boil_sg').change(function(evt){updateActualResultsUI(evt,expected);});
									$('#boil_time').change(function(evt){updateActualResultsUI(evt,expected);});
									$('#boil_end_volume').change(function(evt){updateActualResultsUI(evt,expected);});

									$('#final_volume').change(function(evt) { updateActualResultsUI(evt, expected); });
									$('#actual_og').change(function(evt) { updateActualResultsUI(evt, expected); });
									$('#actual_fg').change(function(evt) { updateActualResultsUI(evt, expected); });
									
									$('#saveButton').click(function(evt) {
										var results=updateActualResults();
										batchData.results=results;
										batchData.id=batchId;
										// console.log(batchData);
										$('#json_data').html(JSON.stringify(batchData));
									});
									
									// Add Tumblr log
									$.getScript("http://geekbrewing.tumblr.com/api/read/json?tagged=" + batchId,
										function(ignore,textStatus,xhr) {
											tumblr_api_read.posts.sort(function(a,b){
												return a['unix-timestamp'] - b['unix-timestamp'];
											})
											$('#brewlog').html($('#brewlogTemplate').render(tumblr_api_read));
										}
									);
								});
							}
						)
					}
				)
			}
		)
	}
	</script>
</head>
<body onLoad="renderBatch(getURLParameter('id'));">
	
	<div id="topnav"><a href="index.html">Home</a></div>
	
	<div id="recipe"></div>
	<div id="expected"></div>
	<div id="actual"></div>

	<div id="brewlog">
		<h1>Brew log</h1>
	</div>

</body>
</html>