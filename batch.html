<html>
<head>
	<meta name = "viewport" content = "width = device-width">
	<link rel="stylesheet" type="text/css" href="recipe.css" />
	<!-- As of 10/9/2012, Google APIs is not yet hosting jQuery UI 1.9.0, so using code.jquery.com site for now -->
	<!--<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.0/themes/base/jquery-ui.css">-->
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.0/themes/base/jquery-ui.css">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
	<!-- <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.0/jquery-ui.min.js"></script> -->
	<script src="http://code.jquery.com/ui/1.9.0/jquery-ui.js"></script>
    <script src="https://raw.github.com/BorisMoore/jsrender/master/jsrender.js" type="text/javascript"></script>
	<script src="js/recipe.js"></script>
	<script src="js/github.js"></script>
	<!-- <script src="js/batch.js"></script> -->
	<script src="js/tumblr.js"></script>
	<script type="text/javascript">
	function getURLParameter(name) {
	    return decodeURI(
	        (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
	    );
	}
	
	function addMashTemp(elem) {
		var newElem=$(elem).parent().clone(true);
		$(newElem).children('input').val(""); // Clear it's value
		$(elem).parent().after(newElem);
		$(elem).remove(); // Remove the + button
	}
	
	function delMashTemp(elem) {
		// Delete the idx-th input element under #mash_temp_measurements
		$($(elem).parent()).remove();
	}
	
	function updateAssumptions(evt) {
		return {
			graintemp:fahrenheitToCelsius(parseFloat($('#assumption_graintemp').val().trim())),
			mashtemp:fahrenheitToCelsius(parseFloat($('#assumption_mashtemp').val().trim())),
			mashthickness:parseFloat($('#assumption_mashthickness').val().trim()),
			mashtun_loss:0.946353,
			evaporation_rate:.17
		};
	}
	
	function updateExpectedResultsUI(evt,expected,recipe) {
		if (evt==null) // Default assumptions:
			expected.assumptions={
				graintemp:fahrenheitToCelsius(70),
				mashtemp:fahrenheitToCelsius(152),
				mashthickness:1.5,
				mashtun_loss:0.946353,
				evaporation_rate:.17
			}
		else
			expected.assumptions=updateAssumptions(evt);

		expected.total_gu=recipe.total_ppg;
		expected.expected_gu=recipe.total_ppg * recipe.efficiency / 100;
		/*
			Mash volume:
			1.5 quarts (1.41953 liters) per 1 lb (0.453592kg) of grain 
		*/
		expected.mashvol=recipe.ingredients.fermentables.total_weight / 0.453592 * gallons2liters(expected.assumptions.mashthickness/4);
		/*
			Absorption loss:
			1.2 gallons of water per 10lbs grain
		    4.54249L of water per 4.53592kg grain
		*/
		expected.absorption_loss_vol=4.54249 * (recipe.ingredients.fermentables.total_weight / 4.53592);
		/* Hop absorption loss calc: http://www.homebrewtalk.com/f12/leaf-hop-absorption-measured-241469/ 
			138.3ml (0.1383L) per oz of hops
		*/
		expected.hop_absorption_loss_vol=(recipe.ingredients.hops.total_weight * 28.3495) * 0.1383;
		expected.boil_hours=recipe.boil_time / 60;
		
		expected.mashtemp=((0.2 / expected.assumptions.mashthickness) * (expected.assumptions.mashtemp - expected.assumptions.graintemp)) + expected.assumptions.mashtemp;
		expected.boil_vol= recipe.batch_size / (Math.pow(1 - expected.assumptions.evaporation_rate,expected.boil_hours));
		expected.evaporation_loss_vol=expected.boil_vol * (1 - Math.pow(1 - expected.assumptions.evaporation_rate,expected.boil_hours)),
		expected.sparge_vol=expected.boil_vol - (expected.mashvol - expected.absorption_loss_vol - expected.hop_absorption_loss_vol - expected.assumptions.mashtun_loss);
		expected.lauter_gravity=gu2sg((recipe.total_grain_ppg * recipe.efficiency / 100) / liters2gallons(expected.boil_vol)); 
		expected.adjunct_gu=recipe.total_adjunct_ppg / liters2gallons(expected.boil_vol);

		if (evt==null) // We have to render the entire template the first time
			$('#expected').html($('#expectedTemplate').render(expected));

		$('#expected_strike_vol').html($('#volumeTemplate').render(expected.mashvol));
		$('#expected_strike_temp').html($('#temperatureTemplate').render(((0.2 / expected.assumptions.mashthickness) * (expected.assumptions.mashtemp - expected.assumptions.graintemp)) + expected.assumptions.mashtemp));
		$('#expected_sparge_vol').html($('#volumeTemplate').render(expected.sparge_vol));
		$('#expected_boil_vol').html($('#volumeTemplate').render(expected.boil_vol,{gravity:expected.lauter_gravity}));
		// $('#').html($('#Template').render();
		// {{for boil_vol ~gravity=lauter_gravity tmpl="#volumeTemplate"/}}
		
	}
	
	function get_mash_temp_measurements() {
		// return [{
		// 	"temp": 42
		// }]
		var vals=new Array;
		$('#mash_temp_measurements :text').each(function(i) {
			vals.push({"temp":fahrenheitToCelsius(parseFloat($(this).val()))})
		});
		return vals;
	}
	
	function updateActualResults(evt){
		// Get values from form
		var results={
			"mash":{
				"type": "",
				"duration":$('#mash_duration').val().trim(),
				"strike": {
					"volume":gallons2liters($('#mash_strike_volume').val().trim()),
					"temp":fahrenheitToCelsius($('#mash_strike_temp').val().trim())
				},
				"measurements": get_mash_temp_measurements()
			},
			"sparge": {
				"duration": $('#lauter_time').val().trim()
			},
			"boil": {
				"volume":	 gallons2liters($('#boil_volume').val().trim()),
				"sg":		 $('#boil_sg').val().trim(),
				"time":		 $('#boil_time').val().trim(),
				"end_volume":gallons2liters($('#boil_end_volume').val().trim())
			},
			"gravity": {
				"volume": gallons2liters($('#final_volume').val().trim().length ? $('#final_volume').val().trim() : $('#boil_end_volume').val().trim()),
				"og": $('#actual_og').val().trim(),
				"fg": $('#actual_fg').val().trim()
			}
		};

		/* 
			If the FG measurement is in Brix, convert to specific gravity:
			SG=1.001843-0.002318474(OB)-0.000007775(OB^2)-0.000000034(OB^3)+0.00574(AB) +0.00003344(AB^2)+0.000000086(AB^3)
		*/
		var m=results.gravity.fg.match(/(\d+\.\d{1,2})\s*%/);
		if (m) { // Looks like a Brix value
			results.gravity.fg=parseFloat(m[1]);
			var brix=sg2brix(results.gravity.og);
			results.gravity.fg=1.001843 - (0.002318474 * brix) - (0.000007775 * Math.pow(brix,2)) - (0.000000034 * Math.pow(brix,3)) + (0.00574 * results.gravity.fg) + (0.00003344 * Math.pow(results.gravity.fg,2)) + (0.000000086 * Math.pow(results.gravity.fg,3));
			$('#actual_fg').val(results.gravity.fg.toFixed(3));
		}

		return results;
	}
										
	function updateActualResultsUI(evt,expected) {
		var results=updateActualResults();

		// Update evaporation rate
		$('#evaporation_rate').html($('#evaporationRateTemplate').render(results.boil));

		// Update boil end gravity
		if (results.boil.sg && results.boil.volume && results.boil.end_volume)
			$('#boil_end_gravity').html(((results.boil.sg - 1) * 1000 * liters2gallons(results.boil.volume) / liters2gallons(results.boil.end_volume) / 1000 + 1).toFixed(3));

		// Update final volume			
		$('#final_volume').val(liters2gallons(results.gravity.volume));

		// Update mash efficiency
		if (results && results.boil && results.boil.sg && results.boil.volume && expected.total_gu)
			$('#mash_efficiency').html(((((results.boil.sg - 1) * 1000) * liters2gallons(results.boil.volume)) / expected.total_gu * 100).toFixed(0) + "%");
		else
			$('#mash_efficiency').html("");

		// Update brewhouse efficiency
		if (results.gravity.volume && results.gravity.og)
			$('#brewhouse_efficiency').html((liters2gallons(results.gravity.volume) * sg2gu(results.gravity.og) / expected.total_gu * 100).toFixed(0) + "%");
		else
			$('#brewhouse_efficiency').html("");
		
		/* Update ABV
		From http://www.brewersfriend.com/2011/06/16/alcohol-by-volume-calculator-updated/:
		ABV =(76.08 * (og-fg) / (1.775-og)) * (fg / 0.794)
		*/
		if (results.gravity.og && results.gravity.fg)
			$('#actual_abv').html(
				(76.08 * ((results.gravity.og - results.gravity.fg) / (1.775 - results.gravity.og)) * (results.gravity.fg / 0.794)).toFixed(2) + "%");
		else
			$('#actual_abv').html("");
		
		// Update ADF
		if (results.gravity.og && results.gravity.fg)
			$('#actual_adf').html(((1 - (sg2gu(results.gravity.fg) / sg2gu(results.gravity.og))) * 100).toFixed(0) + "%");
		else
			$('#actual_adf').html("");
	}
	
	function renderBatch(batchId) {
		
		$.views.helpers({
			g2oz: g2oz,
			oz2g: oz2g,
			kg2lbs: kg2lbs,
			lbs2kg: lbs2kg,
			liters2gallons: liters2gallons,
			gallons2liters: gallons2liters,
			celsius2fahrenheit: celsiusToFahrenheit,
			fahrenheit2celsius: fahrenheitToCelsius,
			metricFormat: metricFormat,
			usFormat: usFormat
		})
		
		$('#topnav').append(" &gt; Batch " + batchId);
		
		// Create a place to put the templates we're going to include
		$(document.body).append('<div id="batchTemplates"></div>');

		// Create a place to put the templates we're going to include
		$(document.body).append('<div id="recipeTemplates"></div>');
				
		$('#recipe').addClass('loading');
		$('#batchTemplates').load("templates/batch.html",
			null,
			function(data,textStatus,xhr) {
				$('#recipeTemplates').load("templates/recipe.html",
					null,
					function(data,textStatus,xhr) {
						// Get the recipe Id from the batch
						github_get_latest_version("batches/" + batchId + "/batch.json",
							function(batchData) {
								displayRecipe(batchData.recipe,$('#recipe'),$('#recipeTemplate'),function(recipe) {
									//
									// Compute the expected data
									//
									
									// For recipes with adjuncts, the PPG may be lower than the total_ppg. We just want
									// to calculate the GU for the grains because that's what is mashed. Adjuncts
									// are added to the boil kettle and shouldn't be included in the lautered gravity.
									recipe.total_grain_ppg=0;
									recipe.total_adjunct_ppg=0;
									for (var i=0; i< recipe.ingredients.fermentables.list.length; ++i) {
										if (recipe.ingredients.fermentables.list[i].type=="Grain")
											recipe.total_grain_ppg+=recipe.ingredients.fermentables.list[i].yield / 100 * 46 * kg2lbs(recipe.ingredients.fermentables.list[i].amount);
										else
											recipe.total_adjunct_ppg+=recipe.ingredients.fermentables.list[i].yield / 100 * 46 * kg2lbs(recipe.ingredients.fermentables.list[i].amount);
									}

									var expected=new Object;
									updateExpectedResultsUI(null,expected,recipe);
									//
									// Display the actual results data
									//
									$('#actual').html($('#actualTemplate').render({
										recipe: recipe,
										expected: expected,
										results: batchData.results
									}));
									updateActualResultsUI(null,expected);
									
									// Setup javsacript triggers
									$('#lauter_time').change(function(evt) {
										if ($.isNumeric($('#boil_volume').val()))
											$('#lauter_rate').html(($('#lauter_time').val() / $('#boil_volume').val()).toFixed(0));
										else
											$('#lauter_rate').html("");
									});
									
									$('#assumption_mashthickness').change(function(evt){updateExpectedResultsUI(evt,expected,recipe);})
									$('#assumption_mashtemp').change(function(evt){updateExpectedResultsUI(evt,expected,recipe);})
									$('#assumption_graintemp').change(function(evt){updateExpectedResultsUI(evt,expected,recipe);})
		
									
									$('#boil_volume').change(function(evt){updateActualResultsUI(evt,expected);});
									$('#boil_sg').change(function(evt){updateActualResultsUI(evt,expected);});
									$('#boil_time').change(function(evt){updateActualResultsUI(evt,expected);});
									$('#boil_end_volume').change(function(evt){updateActualResultsUI(evt,expected);});

									$('#final_volume').change(function(evt) { updateActualResultsUI(evt, expected); });
									$('#actual_og').change(function(evt) { updateActualResultsUI(evt, expected); });
									$('#actual_fg').change(function(evt) { updateActualResultsUI(evt, expected); });
									
									$('#saveButton').click(function(evt) {
										var results=updateActualResults();
										batchData.results=results;
										batchData.id=batchId;
										
										// Post it to Github
										github_commit([{
											"filepath": "batches/"+batchId+"/batch.json",
											"content": JSON.stringify(batchData)
										}],
										"Updated Actual Results for batch " + batchId
										);
										
										// Update batches/index.json
										github_get_latest_version("batches/index.json",function(index){
											
											// Add more info for index.json
											batchData.recipe.name=recipe.name;
											batchData.recipe.total_ppg=recipe.total_ppg;
											batchData.recipe.yeast=recipe.ingredients.yeast;
											batchData.recipe.orig_batch_size=recipe.batch_size;
											
											// Find this batch in the list of batches
											var found=false;
											for (var i=0; i < index.batches.length; ++i) {
												if (index.batches[i].id==batchId) {
													index.batches[i]=batchData;
													found=true;
													break;
												}
											}
											if (!found) {
												index.batches.push(batchData);
											}
											// console.log(batchData);
											// Commit the updated index.json
											github_commit(
												[{
													"filepath": "batches/index.json",
													"content": JSON.stringify(index)
												}],
												"Updated with batch " + batchId
											);
										});
									});
									
									// Add Tumblr log
									$.getScript("http://geekbrewing.tumblr.com/api/read/json?tagged=" + batchId,
										function(ignore,textStatus,xhr) {
											tumblr_api_read.posts.sort(function(a,b){
												return a['unix-timestamp'] - b['unix-timestamp'];
											})
											$('#brewlog').html($('#brewlogTemplate').render(tumblr_api_read));
										}
									);
								});
							}
						)
					}
				)
			}
		)
	}
	</script>
</head>
<body onLoad="renderBatch(getURLParameter('id'));">
	
	<div id="topnav"><a href="index.html">Home</a></div>
	
	<div id="recipe"><div class="modal"></div></div>
	<div id="expected"></div>
	<div id="actual"></div>

	<div id="brewlog">
		<h1>Brew log</h1>
	</div>

</body>
</html>