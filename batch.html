<html>
<head>
	<link rel="stylesheet" type="text/css" href="recipe.css" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script src="https://raw.github.com/BorisMoore/jsrender/master/jsrender.js" type="text/javascript"></script>
	<script src="js/recipe.js"></script>
	<!-- <script src="js/batch.js"></script> -->
	<script src="js/tumblr.js"></script>
	<script type="text/javascript">
	function fahrenheitToCelsius(f) {return (f - 32) * 5 / 9;}
	function celsiusToFahrenheit(c) {return 9 / 5 * (c + 32);}
	function kg2lbs(kg) { return kg * 2.20462; }
	function liters2gallons(l) { return l * 0.264172; }
	function gu2sg(gu) { return gu / 1000 + 1; }
	function getURLParameter(name) {
	    return decodeURI(
	        (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
	    );
	}
	function renderBatch(batchId) {
		$('#topnav').append(" &gt; Batch " + batchId);
		
		// Create a place to put the templates we're going to include
		$(document.body).append('<div id="batchTemplates"></div>');

		// Create a place to put the templates we're going to include
		$(document.body).append('<div id="recipeTemplates"></div>');
				
		$('#batchTemplates').load("templates/batch.html",
			null,
			function(data,textStatus,xhr) {
				$('#recipeTemplates').load("templates/recipe.html",
					null,
					function(data,textStatus,xhr) {
						// Get the recipe Id from the batch
						$.getJSON("batches/" + batchId + "/batch.json",
							null,
							function(batchData,textStatus,xhr) {
								displayRecipe(batchData.recipe.id,$('#recipe'),$('#recipeTemplate'),function(recipe) {
									//
									// Compute the expected data
									//
									
									// For recipes with adjuncts, the PPG may be lower than the total_ppg. We just want
									// to calculate the GU for the grains because that's what is mashed. Adjuncts
									// are added to the boil kettle and shouldn't be included in the lautered gravity.
									recipe.total_grain_ppg=0;
									recipe.total_adjunct_ppg=0;
									for (var i=0; i< recipe.ingredients.fermentables.list.length; ++i) {
										if (recipe.ingredients.fermentables.list[i].type=="Grain")
											recipe.total_grain_ppg+=recipe.ingredients.fermentables.list[i].yield / 100 * 46 * kg2lbs(recipe.ingredients.fermentables.list[i].amount);
										else
											recipe.total_adjunct_ppg+=recipe.ingredients.fermentables.list[i].yield / 100 * 46 * kg2lbs(recipe.ingredients.fermentables.list[i].amount);
									}
									
									var expected={
										// Assumptions:
										assumptions: {
											graintemp:fahrenheitToCelsius(70),
											mashtemp:fahrenheitToCelsius(152),
											mashthickness:1.5,
											mashtun_loss:0.946353,
											evaporation_rate:.17
										},
										total_gu: recipe.total_ppg,
										expected_gu: recipe.total_ppg * recipe.efficiency / 100,
										/*
											Mash volume:
											1.5 quarts (1.41953 liters) per 1 lb (0.453592kg) of grain 
										*/
										mashvol: recipe.ingredients.fermentables.total_weight / 0.453592 * 1.41953,
										/*
											Absorption loss:
											1.2 gallons of water per 10lbs grain
										    4.54249L of water per 4.53592kg grain
										*/
										absorption_loss_vol: 4.54249 * (recipe.ingredients.fermentables.total_weight / 4.53592),
										/* Hop absorption loss calc: http://www.homebrewtalk.com/f12/leaf-hop-absorption-measured-241469/ 
											138.3ml (0.1383L) per oz of hops
										*/
										hop_absorption_loss_vol: (recipe.ingredients.hops.total_weight * 28.3495) * 0.1383,
										boil_hours: recipe.boil_time / 60
									}
							
									expected.boil_vol= recipe.batch_size / (Math.pow(1 - expected.assumptions.evaporation_rate,expected.boil_hours));
									expected.evaporation_loss_vol=expected.boil_vol * (1 - Math.pow(1 - expected.assumptions.evaporation_rate,expected.boil_hours)),
									expected.sparge_vol=expected.boil_vol - (expected.mashvol - expected.absorption_loss_vol - expected.hop_absorption_loss_vol - expected.assumptions.mashtun_loss);
									expected.lauter_gravity=gu2sg((recipe.total_grain_ppg * recipe.efficiency / 100) / liters2gallons(expected.boil_vol)); 
									expected.adjunct_gu=recipe.total_adjunct_ppg / liters2gallons(expected.boil_vol);
							
									$('#expected').html($('#expectedTemplate').render(expected));

									//
									// Display the actual results data
									//
									$.getJSON('batches/' + batchId + '/batch.json',
										null,
										function(actual,textStatus,xhr) {
											$('#actual').html($('#actualTemplate').render({
												recipe: recipe,
												expected: expected,
												results: actual.results
											}));
										}
									);
								});
							}
						)
					}
				)
			}
		)
	}
	</script>
</head>
<body onLoad="renderBatch(getURLParameter('id'));">
	
	<div id="topnav"><a href="index.html">Home</a></div>
	
	<div id="recipe"></div>
	<div id="expected"></div>
	<div id="actual"></div>

</body>
</html>