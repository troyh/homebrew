<html xmlns:exslt="http://exslt.org/common">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name = "viewport" content = "width = device-width">
<title>Homebrewing</title>
<link rel="stylesheet" type="text/css" href="recipe.css">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
<script src="https://raw.github.com/BorisMoore/jsrender/master/jsrender.js" type="text/javascript"></script>
<script src="js/recipe.js"></script>
<script src="js/github.js"></script>

<!--
Bash script to create batches/index.json:

find  batches -type f -name batch.json | while read B; do cat $B | php  -r '$batch=json_decode(file_get_contents("php://STDIN"));$batch->id="$argv[1]";$blob=json_decode(file_get_contents($batch->recipe->url));$recipe=json_decode(base64_decode($blob->content));$batch->recipe->name=$recipe->name;$batch->recipe->total_ppg=$recipe->total_ppg;$batch->recipe->yeast=$recipe->ingredients->yeast;print json_encode($batch)."\n";' "$(basename $(dirname $B))"; done | sed -e 's/$/,/' -e '$,$s/,$//' -e '1i\
{"batches":[' -e '$a\
]}' | jsontidy > batches/index.json
-->
<script type="text/x-jsrender" id="yeastIndexTemplate">
{{fields #data}}
<li>{{:lab}} {{:~key}} {{:name}}</li>
{{/fields}}
</script>

<script type="text/x-jsrender" id="batchIndexTemplate">
{{for batches}}
<tr>
	<td>{{:id}}</td>
	<td><a href="batch.html?id={{:id}}">{{:recipe.name}}</a></td>
	<td>{{if results && results.efficiency.mash}}<span class="percent">{{:results.efficiency.mash.toFixed(0)}}</span>{{/if}}</td>
	<td>{{if results && results.efficiency.brewhouse}}<span class="percent">{{:results.efficiency.brewhouse.toFixed(0)}}</span>{{/if}}</td>
	<td>{{if results && results.mash && results.mash.avg_temp}}<span class="temperature"><span class="fahrenheit">{{:~celsius2fahrenheit(results.mash.avg_temp).toFixed(0)}}</span></span>{{/if}}</td>
	<td>{{if results && results.gravity && results.gravity.og}}{{:results.gravity.og}}{{/if}}</td>
	<td>{{if results && results.gravity && results.gravity.fg}}{{:results.gravity.fg}}{{/if}}</td>
	<td>{{if results && results.gravity && results.gravity.og &&  results.gravity.fg}}{{:~calcABV(results.gravity.og,results.gravity.fg).toFixed(1)}}%{{/if}}</td>
	<td>{{if results && results.gravity && results.gravity.adf}}<span class="percent">{{:results.gravity.adf.toFixed(0)}}</span>{{/if}}</td>
	<td>{{for recipe.yeast}}{{if lab.substring(0,6) == "Wyeast"}}WY{{/if}}{{:prod_id}}{{/for}}</td>
	<td></td>
	<td>{{if results && results.gravity && results.gravity.volume}}{{:~liters2gallons(results.gravity.volume).toFixed(2)}}G{{/if}}</td>
</tr>
{{/for}}
</script>

<script type="text/x-jsrender" id="batchIndexSummaryRowTemplate">
<tr>
	<th></th>
	<th>Average</th>
	<th>{{:averages.efficiency.mash.toFixed(0)}}%</th>
	<th>{{:averages.efficiency.brewhouse.toFixed(0)}}%</th>
	<th></th>
	<th></th>
	<th></th>
	<th>{{:averages.abv.toFixed(1)}}%</th>
	<th>{{:averages.adf.toFixed(0)}}%</th>
	<th></th>
	<th></th>
	<th>{{:(~liters2gallons(totals.vol) / 31).toFixed(0)}}bbl</th>
</tr>
</script>


<script type="text/javascript">
function renderPage() {
	
	$.views.helpers({
		liters2gallons: liters2gallons,
		gallons2liters: gallons2liters,
		celsius2fahrenheit: celsiusToFahrenheit,
		fahrenheit2celsius: fahrenheitToCelsius,
		sg2gu: sg2gu,
		gu2sg: gu2sg,
		calcABV: calcABV
	});
	
	$.views.tags({
		fields: function(obj) {
			var ret="";
			for (var f in obj) {
				ret += this.renderContent(obj[f],{key:f});
			}
			return ret;
		}
	});

	$('#batches').addClass("loading");
	github_get_latest_version("batches/index.json",function(data){
		
		var yeasts=new Object;

		data.totals={
			efficiency: {
				mash: 0,
				mash_count: 0,
				brewhouse: 0,
				brewhouse_count: 0
			},
			abv: 0,
			abv_count: 0,
			adf: 0,
			adf_count: 0,
			vol: 0,
			vol_count: 0
		}
		
		for (var i=0; i < data.batches.length; ++i) {
			// Calculate efficiencies and attenuations
			if (data.batches[i].results) {
				// Scale it
				var scale_factor=1;
				if (data.batches[i].recipe.batch_size)
					scale_factor=data.batches[i].recipe.orig_batch_size / data.batches[i].recipe.batch_size;
				
				data.batches[i].results.efficiency=new Object;
				if (data.batches[i].results.boil.sg && data.batches[i].results.boil.volume) {
					data.batches[i].results.efficiency.mash=(sg2gu(data.batches[i].results.boil.sg) * liters2gallons(data.batches[i].results.boil.volume)) / (data.batches[i].recipe.total_ppg / scale_factor) * 100;
					data.totals.efficiency.mash+=data.batches[i].results.efficiency.mash;
					data.totals.efficiency.mash_count++;
				}
				if (data.batches[i].results.gravity.og && data.batches[i].results.gravity.volume) {
					data.batches[i].results.efficiency.brewhouse=(sg2gu(data.batches[i].results.gravity.og) * liters2gallons(data.batches[i].results.gravity.volume)) / (data.batches[i].recipe.total_ppg / scale_factor) * 100;
					data.totals.efficiency.brewhouse+=data.batches[i].results.efficiency.brewhouse;
					data.totals.efficiency.brewhouse_count++;
				}

				if (data.batches[i].results.gravity && data.batches[i].results.gravity.og && data.batches[i].results.gravity.fg) {
					data.batches[i].results.gravity.adf=(sg2gu(data.batches[i].results.gravity.og) - sg2gu(data.batches[i].results.gravity.fg)) / sg2gu(data.batches[i].results.gravity.og) * 100;
					
					data.batches[i].results.abv=calcABV(data.batches[i].results.gravity.og,data.batches[i].results.gravity.fg);
					data.totals.abv+=data.batches[i].results.abv;
					data.totals.abv_count++;
					data.totals.adf+=data.batches[i].results.gravity.adf;
					data.totals.adf_count++;
				}
				if (data.batches[i].results.gravity.volume) {
					data.totals.vol+=data.batches[i].results.gravity.volume;
					data.totals.vol_count++;
				}
					
				if (data.batches[i].results.mash && data.batches[i].results.mash.measurements) {
					// Calculate average mash temp
					var total=0;
					for (var j=0; j < data.batches[i].results.mash.measurements.length; ++j) {
						total+=data.batches[i].results.mash.measurements[j].temp;
					}
					data.batches[i].results.mash.avg_temp=total / data.batches[i].results.mash.measurements.length;
				}

			}
			
			for (var y=0; y < data.batches[i].recipe.yeast.length; ++y) {
				var hash=data.batches[i].recipe.yeast[y].prod_id;
				if (typeof(yeasts[hash])==='undefined')
					yeasts[hash]=data.batches[i].recipe.yeast[y];
			}
		}
		// Calculate averages
		data.averages={
			efficiency: {
				mash: data.totals.efficiency.mash / data.totals.efficiency.mash_count,
				brewhouse: data.totals.efficiency.brewhouse / data.totals.efficiency.brewhouse_count
			},
			abv: data.totals.abv / data.totals.abv_count,
			adf: data.totals.adf / data.totals.adf_count,
			vol: data.totals.vol / data.totals.vol_count
		}
		
		// Sort by batch ID
		data.batches.sort(function(a,b) {return a.id - b.id;});
		
		$('table#batches tr:nth-child(2)').after($('#batchIndexTemplate').render(data));
		$('table#batches').append($('#batchIndexSummaryRowTemplate').render(data));
		
		$('#yeasts').html($('#yeastIndexTemplate').render(yeasts));
		
		$('#batches th').click(function(evt){
			switch ($(this).prevAll().length) {
			case 0:
				data.batches.sort(function(a,b) {return a.id - b.id;});
				break;
			case 1: // Name
				data.batches.sort(function(a,b) { return a.recipe.name.localeCompare(b.recipe.name); });
				break;
			case 2: // Mash efficiency
				data.batches.sort(function(a,b) {return a.results.efficiency.mash - b.results.efficiency.mash;});
				break;
			case 3: // Brewhouse efficiency
				data.batches.sort(function(a,b) {return a.results.efficiency.brewhouse - b.results.efficiency.brewhouse;});
				break;
			case 4: // Mash temp
				data.batches.sort(function(a,b) {return a.results.mash.avg_temp - b.results.mash.avg_temp;});
				break;
			case 5: // OG
				data.batches.sort(function(a,b) {return a.results.gravity.og - b.results.gravity.og;});
				break;
			case 6: // FG
				data.batches.sort(function(a,b) {return a.results.gravity.fg - b.results.gravity.fg;});
				break;
			case 7: // ABV
				data.batches.sort(function(a,b) {return a.results.abv - b.results.abv;});
				break;
			case 8: // ADF
				data.batches.sort(function(a,b) {return a.results.gravity.adf - b.results.gravity.adf;});
				break;
			case 9: // Yeast
				data.batches.sort(function(a,b) {return a.recipe.yeast[0].prod_id.localeCompare(b.recipe.yeast[0].prod_id);});
				break;
			case 11: // Volume
				data.batches.sort(function(a,b) {return a.results.gravity.volume - b.results.gravity.volume;});
				break;
			}
			// $('table#batches tr').slice(2,24).remove();
			$('table#batches td').remove();
			$('table#batches tr:empty').remove();
			$('table#batches tr:last').before($('#batchIndexTemplate').render(data));
		});
	})
}
</script>

</head>
<body onLoad="renderPage();">
<h1>Homebrewing</h1>

<div>
	<h2>Batches</h2>
	<table id="batches">
		<tr>
			<th></th>
			<th></th>
			<th colspan="2">Efficiency</th>
			<th></th>
			<th></th>
			<th></th>
			<th></th>
			<th colspan="2">Fermentation</th>
		</tr>
		<tr>
			<th>#</th>
			<th>Name</th>
			<th>Mash</th>
			<th>Brewhouse</th>
			<th>Mash temp</th>
			<th>OG</th>
			<th>FG</th>
			<th>ABV</th>
			<th>ADF</th>
			<th>Yeast</th>
			<th>Temp</th>
			<th>Vol</th>
		</tr>
	</table>
	<div class="modal"></div>
</div>

<h2>Recipes</h2>
<ol>
</ol>

<h2>Yeasts</h2>
<ol id="yeasts"></ol>

</body>
</html>
